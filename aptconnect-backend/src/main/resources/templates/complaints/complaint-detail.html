<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <title>ë¯¼ì› ìƒì„¸ ì •ë³´</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>
<div th:if="${currentRole == 'ROLE_MASTER'}">
    <div th:replace="~{/master/navbar :: navbar}"></div>
</div>
<div th:if="${currentRole == 'ROLE_ADMIN'}">
    <div th:replace="~{/admin/navbar :: navbar}"></div>
</div>
<div th:if="${currentRole == 'ROLE_USER'}">
    <div th:replace="~{/register/navbar :: navbar}"></div>
</div>

<div class="container mt-4">
    <h2>ë¯¼ì› ìƒì„¸ ì •ë³´</h2>

    <div class="card">
        <div class="card-header">
            <h5 th:text="${complaint.title}"></h5>
        </div>
        <div class="card-body">
            <p><strong>ì¹´í…Œê³ ë¦¬:</strong> <span th:text="${complaint.category}"></span></p>
            <p><strong>ë‚´ìš©:</strong></p>
            <p th:text="${complaint.content}"></p>
            <p><strong>ì‘ì„±ì¼:</strong> <span th:text="${#temporals.format(complaint.createdAt, 'yyyy-MM-dd HH:mm')}"></span></p>
            <p><strong>í˜„ì¬ ìƒíƒœ:</strong>
                <span id="complaintStatus" class="badge"
                      th:classappend="${complaint.status == 'PENDING' ? 'bg-warning'
                      : (complaint.status == 'IN_PROGRESS' ? 'bg-primary'
                      : 'bg-success')}"
                      th:text="${complaint.status}">
                </span>
            </p>
            <!-- ğŸ”¥ ADMIN ë˜ëŠ” MASTERë§Œ ìƒíƒœ ë³€ê²½ ê°€ëŠ¥ -->
            <div th:if="${currentRole == 'ROLE_ADMIN' || currentRole == 'ROLE_MASTER'}">
                <label for="statusSelect" class="form-label">ìƒíƒœ ë³€ê²½</label>
                <select id="statusSelect" class="form-select">
                    <option value="PENDING" th:selected="${complaint.status == 'PENDING'}">ëŒ€ê¸°</option>
                    <option value="IN_PROGRESS" th:selected="${complaint.status == 'IN_PROGRESS'}">ì§„í–‰ ì¤‘</option>
                    <option value="RESOLVED" th:selected="${complaint.status == 'RESOLVED'}">ì™„ë£Œ</option>
                    <option value="REJECTED" th:selected="${complaint.status == 'REJECTED'}">ê±°ì ˆ</option>
                </select>
                <button id="updateStatusBtn" class="btn btn-primary mt-2">ìƒíƒœ ë³€ê²½</button>
            </div>
            <!-- ì‘ì„±ì ì •ë³´ (ìµëª…ì´ë©´ í‘œì‹œ ì•ˆ í•¨) -->
            <div th:if="${!complaint.isAnonymous}">
                <p><strong>ì‘ì„±ì:</strong> <span th:text="${complaint.createdBy.name}"></span></p>
            </div>

            <!-- í˜„ì¬ ë¡œê·¸ì¸í•œ ì‚¬ìš©ì IDë¥¼ Hidden Inputìœ¼ë¡œ ì €ì¥ -->
            <input type="hidden" id="currentUserId" th:value="${currentUser != null ? currentUser.id : 'null'}">

            <!-- ë³¸ì¸ì´ ì‘ì„±í•œ ê²½ìš° ìˆ˜ì •/ì‚­ì œ ë²„íŠ¼ í‘œì‹œ -->
            <div th:if="${currentUser.id == complaint.createdBy.id}">
                <a th:href="@{/complaints/edit/{id}(id=${complaint.id})}" class="btn btn-warning">ìˆ˜ì •</a>
                <a th:href="@{/complaints/delete/{id}(id=${complaint.id})}" class="btn btn-danger"
                   onclick="return confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?');">ì‚­ì œ</a>
            </div>
        </div>
        <div class="mt-4">
            <h4>ëŒ“ê¸€</h4>
            <div id="comments-container">
                <!-- AJAXë¡œ ë™ì ìœ¼ë¡œ ì¶”ê°€ë  ë¶€ë¶„ -->
            </div>

            <!-- âœ… ëŒ“ê¸€ ì…ë ¥ -->
            <div class="mt-3">
                <textarea id="commentContent" class="form-control" placeholder="ëŒ“ê¸€ì„ ì…ë ¥í•˜ì„¸ìš”"></textarea>
                <button id="addCommentBtn" class="btn btn-primary mt-2">ëŒ“ê¸€ ì‘ì„±</button>
            </div>
        </div>
    </div>

    <a href="/complaints" class="btn btn-secondary mt-3">ëª©ë¡ìœ¼ë¡œ</a>

    <script>
        $(document).ready(function () {
            let complaintId = "[[${complaint.id}]]";

            function loadComments() {
                $.get("/complaints/" + complaintId + "/comments", function (comments) {
                    let commentsHtml = "";
                    comments.forEach(comment => {
                        let isOwner = comment.createdById == $("#currentUserId").val();

                        commentsHtml += `
                            <div class="comment" data-id="${comment.id}">
                                <p><strong>${comment.createdByName}</strong> - ${new Date(comment.createdAt).toLocaleString()}</p>
                                <p>${comment.content}</p>
                                   ${isOwner ? `
                                    <button class="editCommentBtn btn btn-sm btn-warning">ìˆ˜ì •</button>
                                    <button class="deleteCommentBtn btn btn-sm btn-danger">ì‚­ì œ</button>
                                    <div class="editCommentForm mt-2" style="display:none;">
                                        <textarea class="form-control editCommentInput">${comment.content}</textarea>
                                        <button class="saveEditCommentBtn btn btn-sm btn-primary mt-1">ì €ì¥</button>
                                        <button class="cancelEditCommentBtn btn btn-sm btn-secondary mt-1">ì·¨ì†Œ</button>
                                    </div>
                                    ` : ""}
                                <hr>
                            </div>`;
                    });
                    $("#comments-container").html(commentsHtml);
                });
            }

            loadComments(); // ì´ˆê¸° ë¡œë“œ
            // âœ… ëŒ“ê¸€ ìˆ˜ì • ë²„íŠ¼ í´ë¦­ ì‹œ, ìˆ˜ì • í¼ í‘œì‹œ
            $(document).on("click", ".editCommentBtn", function () {
                let commentElement = $(this).closest(".comment");
                commentElement.find(".comment-content").hide();
                commentElement.find(".editCommentForm").show();
            });

            // âœ… ìˆ˜ì • ì·¨ì†Œ ë²„íŠ¼ í´ë¦­ ì‹œ, ì›ë˜ ë‚´ìš©ìœ¼ë¡œ ë³µê·€
            $(document).on("click", ".cancelEditCommentBtn", function () {
                let commentElement = $(this).closest(".comment");
                commentElement.find(".editCommentForm").hide();
                commentElement.find(".comment-content").show();
            });

            // âœ… ìˆ˜ì • ì €ì¥ ë²„íŠ¼ í´ë¦­ ì‹œ, AJAX ìš”ì²­ìœ¼ë¡œ ì—…ë°ì´íŠ¸
            $(document).on("click", ".saveEditCommentBtn", function () {
                let commentElement = $(this).closest(".comment");
                let commentId = commentElement.data("id");
                let newContent = commentElement.find(".editCommentInput").val().trim();

                if (newContent === "") {
                    alert("ëŒ“ê¸€ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
                    return;
                }

                $.ajax({
                    url: "/complaints/" + complaintId + "/comments/" + commentId,
                    type: "PATCH",
                    contentType: "application/json",
                    data: JSON.stringify({ content: newContent }),
                    success: function () {
                        loadComments(); // ğŸ”¥ ì „ì²´ ëŒ“ê¸€ ë‹¤ì‹œ ë¶ˆëŸ¬ì˜¤ê¸°
                    },
                    error: function () {
                        alert("ëŒ“ê¸€ ìˆ˜ì •ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
                    }
                });
            });

            // âœ… ëŒ“ê¸€ ì‘ì„±
            $("#addCommentBtn").click(function () {
                let content = $("#commentContent").val().trim();
                if (content === "") {
                    alert("ëŒ“ê¸€ì„ ì…ë ¥í•˜ì„¸ìš”.");
                    return;
                }

                $.ajax({
                    url: "/complaints/" + complaintId + "/comments",
                    type: "POST",
                    contentType: "application/json",  // âœ… JSONìœ¼ë¡œ ì „ì†¡
                    data: JSON.stringify({ content: content }),  // âœ… JSON í˜•ì‹ìœ¼ë¡œ ë³€í™˜
                    success: function () {
                        loadComments(); // ğŸ”¥ ì „ì²´ ëŒ“ê¸€ ë‹¤ì‹œ ë¶ˆëŸ¬ì˜¤ê¸°
                        content.remove();
                    },
                    error: function (xhr) {
                        alert("ëŒ“ê¸€ ì‘ì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: " + xhr.responseText);
                    }
                });
            });

            // âœ… ëŒ“ê¸€ ì‚­ì œ
            $(document).on("click", ".deleteCommentBtn", function () {
                let commentId = $(this).closest(".comment").data("id");
                let commentElement = $(this).closest(".comment");

                $.ajax({
                    url: "/complaints/" + complaintId + "/comments/" + commentId,
                    type: "DELETE",
                    success: function () {
                        commentElement.remove();
                        alert("ëŒ“ê¸€ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
                    },
                    error: function () {
                        alert("ëŒ“ê¸€ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
                    }
                });
            });
        });
    </script>

    <script>
        $(document).ready(function () {
            $("#updateStatusBtn").click(function () {
                let complaintId = "[[${complaint.id}]]";
                let newStatus = $("#statusSelect").val();

                $.ajax({
                    url: "/complaints/" + complaintId + "/status",
                    type: "PATCH",
                    contentType: "application/json", // âœ… JSON í˜•ì‹ìœ¼ë¡œ ì „ì†¡
                    data: JSON.stringify({ newStatus: newStatus }), // âœ… JSON ë°ì´í„° ë³€í™˜
                    success: function (response) {
                        console.log("âœ… ìƒíƒœ ë³€ê²½ ì„±ê³µ:", response);

                        // âœ… ìƒíƒœ í…ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸
                        $("#complaintStatus").text(response.newStatus);

                        // âœ… ìƒíƒœ ë±ƒì§€ ìƒ‰ìƒ ë³€ê²½
                        $("#complaintStatus").removeClass("bg-warning bg-primary bg-success bg-danger");

                        if (response.newStatus === "PENDING") {
                            $("#complaintStatus").addClass("bg-warning");
                        } else if (response.newStatus === "IN_PROGRESS") {
                            $("#complaintStatus").addClass("bg-primary");
                        } else if (response.newStatus === "REJECTED") {
                            $("#complaintStatus").addClass("bg-danger");
                        } else {
                            $("#complaintStatus").addClass("bg-success");
                        }

                        alert("ìƒíƒœê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.");
                    },
                    error: function () {
                        alert("ìƒíƒœ ë³€ê²½ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
                    }
                });
            });
        });
    </script>

</div>
</body>
</html>